<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MomCare Budget & Expenses</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>

<body class="bg-[#a5dbe5] text-[#104b0b] font-['Poppins'] m-0 p-0">

  {% include 'navbar.html' %}

  <main class="max-w-[1300px] mx-auto p-6 md:p-10">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Monthly Budget Summary -->
      <section class="bg-white rounded-xl overflow-hidden shadow-md flex flex-col min-h-[260px]">
        <div class="bg-[#f9a825] text-white p-4 font-semibold text-lg flex items-center justify-between">
          <span>Monthly Budget Summary</span>

          <!-- Custom month/year picker -->
          <div class="relative flex items-center">
            <!-- Form to allow submitting the selection -->
            <form id="custom-month-form" action="{{ request.path }}" method="get">
              <input type="hidden" id="custom-month-input" name="month" value="{{ selected_month_iso or '' }}" />
            </form>

            <!-- Trigger Button -->
            <div id="picker-trigger"
              class="border border-[#e69b22] rounded bg-white px-3 py-1 text-sm min-w-[160px] text-center cursor-pointer select-none hover:bg-gray-50 focus:ring-2 focus:ring-white/20"
              role="button" aria-haspopup="true" aria-expanded="false">
              <span id="picker-display-text" class="text-gray-700 font-medium">
                {{ selected_month }}
              </span>
              <i class="fas fa-calendar-alt ml-2 text-[#f9a825]"></i>
            </div>

            <!-- Dropdown Panel -->
            <div id="picker-dropdown"
              class="hidden absolute top-full right-0 mt-1 w-[280px] bg-white border border-gray-200 rounded-lg shadow-xl z-[100] p-4 text-sm font-sans">
              <!-- Year Header -->
              <div class="flex items-center justify-between mb-4">
                <button type="button" id="year-prev" class="text-gray-500 hover:text-black font-bold px-2">&lt;</button>
                <span id="year-display" class="font-bold text-base text-gray-800"></span>
                <button type="button" id="year-next" class="text-gray-500 hover:text-black font-bold px-2">&gt;</button>
              </div>
              <!-- Months Grid -->
              <div class="grid grid-cols-4 gap-2 text-center" id="months-grid">
                <!-- Javascript will populate this -->
              </div>
            </div>
          </div>
        </div>
        <div class="p-6 flex-1 text-sm">
          <div class="flex justify-between mb-3 text-[15px]">
            <div class="font-medium">Monthly Income</div>
            <div>
              <input type="number" id="incomeInput" value="0" min="0"
                class="border border-gray-300 rounded px-2 py-1 w-36 text-sm">
            </div>
          </div>
          <div class="flex justify-between mb-3 text-[15px]">
            <div class="font-medium">Monthly Budget Limit</div>
            <div>
              <input type="number" id="budgetInput" value="0" min="0"
                class="border border-gray-300 rounded px-2 py-1 w-36 text-sm">
            </div>
          </div>

          <div class="flex justify-between mb-3 text-[15px]">
            <div class="font-medium">Total Spent This Month</div>
            <div class="font-bold text-[#1f4f1e]" id="totalSpentDisplay">‚Ç± {{ "{:,.2f}".format(total_spent) }}</div>
          </div>
          <div class="flex justify-between mb-3 text-[13px] text-gray-500 italic">
            <div>Top Expense</div>
            <div id="topExpenseDisplay" class="font-semibold">None</div>
          </div>

          <div class="border-t border-dashed border-gray-400 my-4"></div>

          <div id="categorySummary" class="text-[13px] my-2 max-h-[80px] overflow-y-auto pr-1"></div>

          <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
            <!-- Left Side: Status -->
            <div id="budgetUsedLabel" class="text-base flex items-center">
              0% Budget Used
            </div>

            <!-- Right Side: Financials -->
            <div class="text-right flex flex-col gap-1">
              <p class="text-sm text-gray-400 m-0" id="remainingDisplay">Remaining Balance: ‚Ç±0.00</p>
              <p class="text-sm text-gray-500 m-0">
                Allocated Savings: <span id="allocatedSavingsDisplay" class="font-bold text-[#5a8d26]">‚Ç±0.00</span>
              </p>
            </div>
          </div>

        </div>
      </section>

      <!-- Spending Category -->
      <section class="bg-white rounded-xl overflow-hidden shadow-md">
        <div class="bg-[#f9a825] text-white p-4 font-semibold text-lg">Spending Category</div>

        <!-- Chart + Category List -->
        <div class="px-4 pt-12 pb-4 flex justify-center">
          <div class="flex flex-col md:flex-row items-center gap-8">
            <div class="relative w-[250px] h-[250px] shrink-0">
              <canvas id="pieChart" width="250" height="250"
                class="rounded-full shadow-[0_0_0_8px_#f1f8e9] bg-white"></canvas>
            </div>
            <!-- Category breakdown with scrollable list showing max 8 items -->
            <div class="w-full max-w-[320px] max-h-[250px] overflow-y-auto pr-2" id="categoryList"></div>
          </div>
        </div>
      </section>

      <!-- Add Expense -->
      <section class="bg-white rounded-xl overflow-hidden shadow-md flex flex-col">
        <div class="bg-[#f9a825] text-white p-4 font-semibold text-lg">Add Expense</div>
        <div class="p-6 flex-1">
          <form id="expenseForm">
            <input type="hidden" id="expenseId" value="">
            <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-3 items-center text-sm">
              <label class="font-medium" for="expenseAmount">Amount</label>
              <input id="expenseAmount" type="number" min="0" step="0.01" placeholder="Enter amount"
                class="w-full border border-gray-300 rounded px-2 py-1.5 focus:outline-none focus:border-[#ed008c]">

              <label class="font-medium" for="expenseCategory">Category</label>
              <div class="flex gap-2">
                <select id="expenseCategory"
                  class="w-full border border-gray-300 rounded px-2 py-1.5 bg-white focus:outline-none focus:border-[#ed008c]">
                  <option value="">Select category</option>
                  <!-- Options populated by JS or hardcoded initially, but we will rely on renderOptions mostly or keep hardcoded and append -->
                </select>
                <button type="button" id="btnAddCategory"
                  class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200" title="Add new category">
                  <i class="fas fa-plus"></i>
                </button>
                <button type="button" id="btnDelCategory"
                  class="px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200" title="Delete selected category">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>

              <label class="font-medium" for="expenseDate">Date</label>
              <input id="expenseDate" type="date"
                class="w-full border border-gray-300 rounded px-2 py-1.5 focus:outline-none focus:border-[#ed008c]">

              <div class="col-span-2 flex items-center gap-2 mt-1">
                <div class="w-5 h-5 border-2 border-[#0e4f23] rounded flex items-center justify-center bg-white">
                  <input type="checkbox" id="ecoCheckbox" class="w-3.5 h-3.5 accent-[#0e4f23]">
                </div>
                <span>Mark as Eco-Spending</span>
                <span class="text-[#4caf50]">üçÉ</span>
              </div>

              <div class="col-span-2 grid grid-cols-[auto_1fr] gap-x-4">
                <label class="font-medium pt-1" for="expenseNotes">Notes</label>
                <textarea id="expenseNotes" placeholder="Add any details about this expense"
                  class="w-full border border-gray-300 rounded px-2 py-1.5 min-h-[60px] focus:outline-none focus:border-[#ed008c] resize-y"></textarea>
              </div>
            </div>

            <div class="flex justify-end gap-3 mt-4">
              <button type="button" id="clearExpenseBtn"
                class="px-4 py-2 rounded-full text-[#607d8b] bg-transparent hover:bg-gray-100 font-medium transition-colors">Cancel</button>
              <button type="submit"
                class="px-4 py-2 rounded-full bg-[#0e4f23] text-white font-medium hover:opacity-90 transition-opacity">
                <span id="expenseSubmitLabel">Add Expense</span>
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- Add Category Modal -->
      <div id="addCategoryModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[200]">
        <div class="bg-white rounded-lg p-6 w-[90%] max-w-sm shadow-2xl">
          <h3 class="text-lg font-bold mb-4 text-gray-800">Add New Category</h3>
          <input type="text" id="newCategoryInput"
            class="w-full border border-gray-300 rounded px-3 py-2 mb-4 focus:outline-none focus:border-[#ed008c]"
            placeholder="Category Name" autocomplete="off">
          <div class="flex justify-end gap-3">
            <button type="button" id="cancelCategoryBtn"
              class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
            <button type="button" id="confirmCategoryBtn"
              class="px-4 py-2 bg-[#0e4f23] text-white rounded hover:opacity-90">Add</button>
          </div>
        </div>
      </div>

      <!-- Delete Category Modal -->
      <div id="deleteCategoryModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[200]">
        <div class="bg-white rounded-lg p-6 w-[90%] max-w-sm shadow-2xl">
          <h3 class="text-lg font-bold mb-4 text-gray-800" id="delModalTitle">Delete Category</h3>
          <p id="delModalMessage" class="text-gray-600 mb-6 text-sm">Are you sure?</p>

          <!-- Actions for confirmation -->
          <div id="delModalActions" class="flex justify-end gap-3 hidden">
            <button type="button" id="cancelDelCatBtn"
              class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
            <button type="button" id="confirmDelCatBtn"
              class="px-4 py-2 bg-red-600 text-white rounded hover:opacity-90">Delete</button>
          </div>

          <!-- Actions for error/info only -->
          <div id="delModalInfoActions" class="flex justify-end gap-3 hidden">
            <button type="button" id="closeDelCatBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Close</button>
          </div>
        </div>
      </div>

      <!-- Delete Expense Modal -->
      <div id="deleteExpenseModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[200]">
        <div class="bg-white rounded-lg p-6 w-[90%] max-w-sm shadow-2xl">
          <h3 class="text-lg font-bold mb-4 text-gray-800">Delete Expense</h3>
          <p class="text-gray-600 mb-6 text-sm">Are you sure you want to delete this expense? This action cannot be
            undone.</p>
          <div class="flex justify-end gap-3">
            <button type="button" id="cancelDelExpBtn"
              class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
            <button type="button" id="confirmDelExpBtn"
              class="px-4 py-2 bg-red-600 text-white rounded hover:opacity-90">Delete</button>
          </div>
        </div>
      </div>

      <!-- Recent Expenses (Card 4) -->
      <section class="bg-white rounded-xl overflow-hidden shadow-md flex flex-col max-h-[400px]">
        <div class="bg-[#f9a825] text-white p-4 font-semibold text-lg flex items-center justify-between">
          <span>Recent Expenses</span>
          <button id="openGroceryListBtn" class="text-white hover:text-gray-200 transition-colors"
            title="Grocery & Household List">
            <i class="fas fa-shopping-cart text-xl"></i>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto relative">
          <table class="w-full text-sm border-collapse text-left">
            <thead class="sticky top-0 z-10 bg-gray-50 text-gray-600 font-medium border-b border-gray-200 shadow-sm">
              <tr>
                <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 transition-colors" id="expenseDateSort">
                  <div class="flex items-center gap-1">
                    <span>Date</span>
                    <i class="fas fa-sort text-gray-400" id="expenseSortIcon"></i>
                  </div>
                </th>
                <th class="px-6 py-3">
                  <select id="expenseCategoryFilter"
                    class="border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:border-[#f9a825] bg-white font-medium">
                    <option value="">Categories</option>
                  </select>
                </th>
                <th class="px-6 py-3">Notes</th>
                <th class="px-6 py-3 text-right min-w-[150px]">Amount</th>
                <th class="px-6 py-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="expenseTableBody" class="divide-y divide-gray-100">
              <!-- JS Populated -->
            </tbody>
          </table>
          <div id="noExpensesMsg" class="text-center text-gray-400 py-6 hidden">No expenses for this month yet.</div>
        </div>
      </section>




    </div>
  </main>

  <!-- Grocery List Modal -->
  <div id="groceryListModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
      <!-- Modal Header -->
      <div class="bg-[#f9a825] text-white p-4 font-semibold text-lg flex items-center justify-between rounded-t-xl">
        <span>Grocery & Household List</span>
        <button id="closeGroceryListBtn" class="text-white hover:text-gray-200 transition-colors">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Add Grocery Form -->
        <div class="mb-6">
          <form id="groceryForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
              <input type="text" id="groceryItemName" required
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-[#f9a825]"
                placeholder="e.g. Rice, Milk">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Est. Cost (‚Ç±)</label>
              <input type="number" id="groceryCost" step="0.01" min="0" required
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-[#f9a825]"
                placeholder="0.00">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
              <input type="number" id="groceryQuantity" value="1" min="1"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-[#f9a825]">
            </div>

            <div class="flex items-end">
              <button type="submit" id="grocerySubmitBtn"
                class="w-full bg-[#0e4f23] text-white px-4 py-2 rounded hover:bg-[#0a3a1a] transition-colors font-medium">
                <span id="grocerySubmitLabel">Add Item</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Grocery Total -->
        <div class="mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg flex justify-between items-center">
          <span class="font-medium text-gray-700">Total Estimated Cost:</span>
          <span id="groceryGrandTotal" class="text-lg font-bold text-[#0e4f23]">‚Ç±0.00</span>
        </div>

        <!-- Grocery Table -->
        <div id="groceryTableWrapper"
          class="border border-gray-200 rounded-lg overflow-hidden max-h-[300px] overflow-y-auto">
          <table class="w-full text-sm border-collapse">
            <thead class="sticky top-0 z-10 bg-gray-50 text-gray-600 font-medium border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-center w-12">‚úì</th>
                <th class="px-4 py-3 text-left">Item</th>
                <th class="px-4 py-3 text-right w-24">Cost</th>
                <th class="px-4 py-3 text-center w-16">Qty</th>
                <th class="px-4 py-3 text-right w-28">Total</th>
                <th class="px-4 py-3 text-center w-24">Actions</th>
              </tr>
            </thead>
            <tbody id="groceryTableBody" class="divide-y divide-gray-100">
              <!-- JS Populated -->
            </tbody>
          </table>
          <div id="noGroceriesMsg" class="text-center text-gray-400 py-6 hidden">No grocery items for this month yet.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Grocery Confirmation Modal -->
  <div id="deleteGroceryModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Delete Item?</h3>
      <p class="text-gray-600 mb-6">Are you sure you want to delete this grocery item? This action cannot be undone.</p>
      <div class="flex gap-3 justify-end">
        <button id="cancelDeleteGrocery"
          class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
          Cancel
        </button>
        <button id="confirmDeleteGrocery"
          class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
          Delete
        </button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     * MomCare Local Persistence (per-month) - v1
     * - Stores settings, expenses, groceries, and draft inputs per month
     * - Uses URL param ?month=YYYY-MM as the active month (preferred)
     * - Falls back to localStorage "selected month"
     * - Hard deletes records (removes from UI + storage)
     ******************************************************************/
    // Categories from database
    let dbCategories = {{ db_categories | tojson | safe }};
    let categories = dbCategories.map(c => c.name);

    const categoryColors = {};
    dbCategories.forEach(c => {
      categoryColors[c.name] = c.color;
    });

    // Make localStorage key user-specific to prevent data sharing between accounts
    const userEmail = {{ user_email | tojson | safe }};
    const STORE_KEY = `momcare_budget_v1_${userEmail}`;

    // ---- Custom Month Picker Logic ----
    (function () {
      const trigger = document.getElementById('picker-trigger');
      const dropdown = document.getElementById('picker-dropdown');
      const hiddenInput = document.getElementById('custom-month-input');
      const form = document.getElementById('custom-month-form');
      const displayText = document.getElementById('picker-display-text');

      const yearDisplay = document.getElementById('year-display');
      const yearPrev = document.getElementById('year-prev');
      const yearNext = document.getElementById('year-next');
      const monthsGrid = document.getElementById('months-grid');

      if (!trigger || !dropdown) return;

      const MONTH_shorts = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const FULL_MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

      // Initial state from value
      let currentIso = hiddenInput.value || new Date().toISOString().slice(0, 7); // YYYY-MM
      let viewYear = parseInt(currentIso.split('-')[0]) || new Date().getFullYear();

      // Toggle dropdown
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = dropdown.classList.contains('hidden');
        if (isHidden) {
          openDropdown();
        } else {
          closeDropdown();
        }
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && !trigger.contains(e.target)) {
          closeDropdown();
        }
      });
      dropdown.addEventListener('click', (e) => e.stopPropagation());

      function openDropdown() {
        dropdown.classList.remove('hidden');
        viewYear = parseInt(currentIso.split('-')[0]) || new Date().getFullYear();
        renderCalendar();
      }

      function closeDropdown() {
        dropdown.classList.add('hidden');
      }

      // Year Navigation
      yearPrev.addEventListener('click', () => {
        viewYear--;
        renderCalendar();
      });

      yearNext.addEventListener('click', () => {
        viewYear++;
        renderCalendar();
      });

      function renderCalendar() {
        yearDisplay.textContent = viewYear;
        monthsGrid.innerHTML = '';

        // Parse current selected to highlight
        const [selY, selM] = currentIso.split('-').map(Number); // integers (selM 1-12)

        MONTH_shorts.forEach((mShort, index) => {
          const mNum = index + 1; // 1-12

          const btn = document.createElement('div');
          btn.textContent = mShort;
          // Styling
          let classes = "py-2 rounded cursor-pointer transition-colors";

          const isSelected = (viewYear === selY && mNum === selM);

          if (isSelected) {
            // HIGHLIGHT COLOR: #f9a825
            btn.className = classes + " text-white font-medium shadow-sm";
            btn.style.backgroundColor = "#f9a825";
          } else {
            btn.className = classes + " text-gray-700 hover:bg-gray-100";
          }

          btn.addEventListener('click', () => {
            selectMonth(viewYear, mNum);
          });

          monthsGrid.appendChild(btn);
        });
      }

      function selectMonth(year, monthNum) {
        // Format YYYY-MM
        const mm = String(monthNum).padStart(2, '0');
        const iso = `${year}-${mm}`;

        currentIso = iso;
        hiddenInput.value = iso;

        // Update text in trigger
        displayText.textContent = `${FULL_MONTHS[monthNum - 1]} ${year}`;

        closeDropdown();
        form.submit();
      }
    })();

    function nowIso() { return new Date().toISOString(); }

    function uuid() {
      return "id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 10);
    }

    function safeParseJSON(str, fallback) {
      try { return JSON.parse(str); } catch { return fallback; }
    }

    function loadStore() {
      const base = { ui: { selectedMonth: null }, months: {} };
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return base;
      const parsed = safeParseJSON(raw, base);
      if (!parsed || typeof parsed !== "object") return base;
      parsed.ui = parsed.ui || { selectedMonth: null };
      parsed.months = parsed.months || {};
      return parsed;
    }

    function saveStore(store) {
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }

    function getMonthIsoFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const m = urlParams.get("month");
      if (m && /^\d{4}-\d{2}$/.test(m)) return m;
      return null;
    }

    function getDefaultMonthIso() {
      return new Date().toISOString().slice(0, 7);
    }

    function getActiveMonthIso() {
      const store = loadStore();
      const fromUrl = getMonthIsoFromUrl();
      if (fromUrl) {
        store.ui.selectedMonth = fromUrl;
        saveStore(store);
        return fromUrl;
      }
      if (store.ui.selectedMonth && /^\d{4}-\d{2}$/.test(store.ui.selectedMonth)) {
        return store.ui.selectedMonth;
      }
      const def = getDefaultMonthIso();
      store.ui.selectedMonth = def;
      saveStore(store);
      return def;
    }

    function ensureMonth(store, monthIso) {
      if (!store.months[monthIso]) {
        store.months[monthIso] = {
          settings: { income: 0, budget_limit: 0 },
          expenses: [],
          groceries: [],
          drafts: {
            expense: { amount: "", category: "", date: "", notes: "" },
            grocery: { item: "", qty: "1", cost: "", category: "" }
          }
        };
      } else {
        store.months[monthIso].settings = store.months[monthIso].settings || { income: 0, budget_limit: 0 };
        store.months[monthIso].expenses = store.months[monthIso].expenses || [];
        store.months[monthIso].groceries = store.months[monthIso].groceries || [];
        store.months[monthIso].drafts = store.months[monthIso].drafts || {
          expense: { amount: "", category: "", date: "", notes: "" },
          grocery: { item: "", qty: "1", cost: "", category: "" }
        };
        store.months[monthIso].drafts.expense = store.months[monthIso].drafts.expense || { amount: "", category: "", date: "", notes: "" };
        store.months[monthIso].drafts.grocery = store.months[monthIso].drafts.grocery || { item: "", qty: "1", cost: "", category: "" };
      }
      return store.months[monthIso];
    }

    function formatCurrency(value) {
      const num = isNaN(value) ? 0 : value;
      return "‚Ç± " + num.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function computeTotals(monthData) {
      let totalSpent = 0;
      const categoryTotals = {};
      categories.forEach(c => categoryTotals[c] = 0);

      for (const exp of monthData.expenses) {
        const amt = Number(exp.amount) || 0;
        const cat = exp.category;
        totalSpent += amt;
        if (categoryTotals.hasOwnProperty(cat)) categoryTotals[cat] += amt;
      }

      for (const g of monthData.groceries) {
        if (!g.checked) continue;
        const amt = Number(g.cost) || 0;
        const cat = g.category || "Groceries";
        totalSpent += amt;
        if (categoryTotals.hasOwnProperty(cat)) categoryTotals[cat] += amt;
      }

      return { totalSpent, categoryTotals };
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ---- UI state ----
    let ACTIVE_MONTH = null;
    let TOTAL_SPENT = 0;
    let CATEGORY_TOTALS = {};
    categories.forEach(c => CATEGORY_TOTALS[c] = 0);

    // ---- UI render helpers ----
    function updateEcoCheckbox() {
      // Eco checkbox is now manually controlled by user
      // No auto-toggling based on budget
    }

    function drawPieChart() {
      const canvas = document.getElementById("pieChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");

      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 2;

      ctx.clearRect(0, 0, width, height);

      if (TOTAL_SPENT <= 0) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fillStyle = "#e8f5e9";
        ctx.fill();
        return;
      }

      let startAngle = -Math.PI / 2;

      categories.forEach(cat => {
        const value = CATEGORY_TOTALS[cat] || 0;
        if (!value) return;

        const sliceAngle = (value / TOTAL_SPENT) * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = categoryColors[cat] || "#ccc";
        ctx.fill();
        startAngle += sliceAngle;
      });

      ctx.fill();
    }

    // ---- Dynamic Categories ----
    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function syncCategoriesWithData(expensesArr) {
      // Add any category found in expenses that isn't in our list
      expensesArr.forEach(e => {
        if (e.category && !categories.includes(e.category)) {
          categories.push(e.category);
          if (!categoryColors[e.category]) {
            categoryColors[e.category] = getRandomColor();
          }
        }
      });
      updateCategorySelect();
    }

    function updateCategorySelect() {
      const sel = document.getElementById("expenseCategory");
      const gb = document.getElementById("groceryBudgetCat");

      [sel, gb].forEach(el => {
        if (!el) return;
        const currentVal = el.value;
        // Keep "Select category" or default options if we want, but easier to rebuild
        // We'll preserve the first option if it is empty value "Select category"
        let firstOpt = el.firstElementChild;
        let hasDefault = firstOpt && firstOpt.value === "";

        el.innerHTML = "";
        if (hasDefault) el.appendChild(firstOpt); // Keep the "Select category"

        categories.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          el.appendChild(opt);
        });

        el.value = currentVal;
      });
    }

    function addNewCategory() {
      const modal = document.getElementById("addCategoryModal");
      const input = document.getElementById("newCategoryInput");
      if (modal && input) {
        input.value = "";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        input.focus();
      }
    }

    function closeCategoryModal() {
      const modal = document.getElementById("addCategoryModal");
      if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    }

    function confirmAddCategory() {
      const input = document.getElementById("newCategoryInput");
      if (!input) return;

      const name = input.value.trim();
      if (!name) return;

      if (categories.includes(name)) {
        alert("Category already exists!");
        return;
      }

      const color = getRandomColor();

      fetch('/api/categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, color })
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            return;
          }
          dbCategories.push(data);
          categories.push(data.name);
          categoryColors[data.name] = data.color;

          updateCategorySelect();
          updateCategoryView(); // Refresh the list view

          // Select it
          const sel = document.getElementById("expenseCategory");
          if (sel) sel.value = data.name;

          closeCategoryModal();
        })
        .catch(err => {
          console.error('Error adding category:', err);
          alert('Failed to add category');
        });
    }

    function deleteCurrentCategory() {
      const sel = document.getElementById("expenseCategory");
      if (!sel) return;

      const catName = sel.value;
      if (!catName) {
        showDeleteModal("No Selection", "Please select a category to delete.", false);
        return;
      }

      const store = loadStore();
      const mData = ensureMonth(store, ACTIVE_MONTH);

      // Check usage in expenses
      const usageExp = (mData.expenses || []).filter(e => e.category === catName).length;
      // Check usage in groceries
      const usageGroc = (mData.groceries || []).filter(g => g.category === catName).length;

      if (usageExp > 0 || usageGroc > 0) {
        const msg = `Cannot delete "${catName}" because it is currently used by ${usageExp} expenses and ${usageGroc} grocery items.\n\nPlease delete these items first.`;
        showDeleteModal("Cannot Delete", msg, false);
        return;
      }

      const modal = document.getElementById("deleteCategoryModal");
      if (modal) modal.dataset.categoryToDelete = catName;
      showDeleteModal("Delete Category", `Are you sure you want to delete "${catName}"? This cannot be undone.`, true);
    }

    function showDeleteModal(title, msg, isConfirm) {
      const modal = document.getElementById("deleteCategoryModal");
      const titleEl = document.getElementById("delModalTitle");
      const msgEl = document.getElementById("delModalMessage");
      const actions = document.getElementById("delModalActions");
      const infoActions = document.getElementById("delModalInfoActions");

      if (!modal) return;

      titleEl.textContent = title;
      msgEl.textContent = msg;

      modal.classList.remove("hidden");
      modal.classList.add("flex");

      if (isConfirm) {
        actions.classList.remove("hidden");
        infoActions.classList.add("hidden");
      } else {
        actions.classList.add("hidden");
        infoActions.classList.remove("hidden");
      }
    }

    function closeDeleteModal() {
      const modal = document.getElementById("deleteCategoryModal");
      if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    }

    function executeDeleteCategory() {
      const modal = document.getElementById("deleteCategoryModal");
      const catName = modal.dataset.categoryToDelete;
      if (!catName) return;

      const catObj = dbCategories.find(c => c.name === catName);
      if (!catObj) {
        closeDeleteModal();
        return;
      }

      fetch(`/api/categories/${catObj.id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            return;
          }
          // Remove locally
          dbCategories = dbCategories.filter(c => c.id !== catObj.id);
          categories = dbCategories.map(c => c.name);
          delete categoryColors[catName];

          updateCategorySelect();
          updateCategoryView();

          // Select first available
          const sel = document.getElementById("expenseCategory");
          if (sel && sel.options.length > 0) sel.selectedIndex = 0;

          closeDeleteModal();
        })
        .catch(err => {
          console.error('Error deleting category:', err);
          alert('Failed to delete category');
        });
    }


    function updateCategorySummary() {
      const container = document.getElementById("categorySummary");
      if (!container) return;
      container.innerHTML = "";

      categories.forEach(cat => {
        const amount = CATEGORY_TOTALS[cat] || 0;
        if (amount <= 0) return;

        const percent = TOTAL_SPENT > 0 ? " (" + ((amount / TOTAL_SPENT) * 100).toFixed(1) + "%)" : "";

        const row = document.createElement("div");
        row.className = "flex justify-between items-center mb-1.5";

        const left = document.createElement("div");
        left.className = "flex items-center gap-2";

        const dot = document.createElement("div");
        dot.className = "w-2.5 h-2.5 rounded-full";
        dot.style.backgroundColor = categoryColors[cat] || "#ccc";

        const name = document.createElement("span");
        name.className = "font-medium";
        name.textContent = cat;

        left.appendChild(dot);
        left.appendChild(name);

        const right = document.createElement("div");
        right.className = "flex items-center gap-2";

        const val = document.createElement("span");
        val.className = "opacity-90";
        val.textContent = formatCurrency(amount) + percent;

        right.appendChild(val);


        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      });
    }

    function updateCategoryView() {
      const listDiv = document.getElementById("categoryList");
      if (!listDiv) return;

      listDiv.innerHTML = "";
      const wrapper = document.createElement("div");
      wrapper.className = "space-y-1.5";

      categories.forEach(cat => {
        const row = document.createElement("div");
        row.className = "flex justify-between text-[13px]";

        const nameDiv = document.createElement("div");
        nameDiv.className = "flex items-center gap-2";

        const bar = document.createElement("div");
        bar.className = "w-4 h-0.5";
        bar.style.backgroundColor = categoryColors[cat] || "#cfd8dc";

        const name = document.createElement("span");
        name.textContent = cat;

        nameDiv.appendChild(bar);
        nameDiv.appendChild(name);

        const amount = CATEGORY_TOTALS[cat] || 0;
        const percent = TOTAL_SPENT > 0 ? ((amount / TOTAL_SPENT) * 100).toFixed(1) : "0.0";

        const val = document.createElement("div");
        val.textContent = `${percent}%`;

        row.appendChild(nameDiv);
        row.appendChild(val);
        wrapper.appendChild(row);
      });

      listDiv.appendChild(wrapper);
      drawPieChart();
      updateCategorySummary();
    }

    function updateSummaryUI() {
      const budgetLimit = Number(document.getElementById("budgetInput").value) || 0;
      const monthlyIncome = Number(document.getElementById("incomeInput").value) || 0;

      document.getElementById("totalSpentDisplay").textContent = formatCurrency(TOTAL_SPENT);

      let displayPercent = 0;
      if (budgetLimit > 0) {
        displayPercent = (TOTAL_SPENT / budgetLimit) * 100;
        // Cap visual percent at 100 for display if needed, but user usually wants to see overage
      }

      // Alert based on Budget Limit
      let alertPercent = 0;
      if (budgetLimit > 0) alertPercent = (TOTAL_SPENT / budgetLimit) * 100;

      const labelEl = document.getElementById("budgetUsedLabel");

      let colorClass = "text-[#0e4f23]"; // Default dark green brand color
      let icon = "";

      if (alertPercent >= 90) {
        colorClass = "text-red-600";
        icon = '<i class="fas fa-exclamation-circle text-red-600 mr-1"></i>';
      } else if (alertPercent >= 70) {
        colorClass = "text-orange-500";
        icon = '<i class="fas fa-exclamation-triangle text-orange-500 mr-1"></i>';
      } else {
        // Safe / Good (Green)
        colorClass = "text-green-600";
        icon = '<i class="fas fa-check-circle text-green-600 mr-1"></i>';
      }

      labelEl.innerHTML = `${icon} <span class="${colorClass} font-bold">${displayPercent.toFixed(1)}% Budget Used</span>`;

      const remaining = budgetLimit - TOTAL_SPENT;
      document.getElementById("remainingDisplay").textContent = "Remaining Balance: " + formatCurrency(remaining);

      const allocatedSavings = monthlyIncome - TOTAL_SPENT;
      const allocDisp = document.getElementById("allocatedSavingsDisplay");
      if (allocDisp) {
        allocDisp.textContent = formatCurrency(allocatedSavings);
      }

      // Real-time Top Expense Calculation
      let topCat = "None";
      let maxAmt = 0;
      for (const cat in CATEGORY_TOTALS) {
        if (CATEGORY_TOTALS[cat] > maxAmt) {
          maxAmt = CATEGORY_TOTALS[cat];
          topCat = cat;
        }
      }
      const topDisp = document.getElementById("topExpenseDisplay");
      if (topDisp) {
        topDisp.textContent = maxAmt > 0 ? `${topCat} (${formatCurrency(maxAmt)})` : "None";
      }

      updateEcoCheckbox();
      updateCategoryView();
    }

    // ---- Groceries rendering ----
    function clearGroceriesRenderedRows() {
      const tbody = document.getElementById("groceryTableBody");
      const inputRow = document.getElementById("groceryInputRow");
      if (!tbody || !inputRow) return;

      [...tbody.querySelectorAll("tr")].forEach(tr => {
        if (tr !== inputRow) tr.remove();
      });
    }

    function addGroceryRow(id, item, qty, cost, category, checked) {
      const tbody = document.getElementById("groceryTableBody");
      const inputRow = document.getElementById("groceryInputRow");
      if (!tbody || !inputRow) return;

      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50 border-b border-gray-100";
      tr.dataset.id = id;

      tr.innerHTML = `\
        <td class="border border-gray-200 p-2 text-center">\
          <input type="checkbox" class="grocery-check accent-[#0e4f23]" ${checked ? "checked" : ""}>\
        </td>\
        <td class="border border-gray-200 p-2">${escapeHtml(item)}</td>\
        <td class="border border-gray-200 p-2 text-center">${Number(qty) || 1}</td>\
        <td class="border border-gray-200 p-2 text-right">‚Ç± ${Number(cost).toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>\
        <td class="border border-gray-200 p-2">${escapeHtml(category || "Groceries")}</td>\
        <td class="border border-gray-200 p-2 text-center">\
          <button type="button" class="btn-remove text-[11px] px-2 py-0.5 bg-red-100 text-red-600 hover:bg-red-200 rounded-full transition-colors">Remove</button>\
        </td>
      `;

      tbody.insertBefore(tr, inputRow);
    }

    // ---- Grocery List Functions ----
    function renderGroceryList(monthData) {
      const tbody = document.getElementById("groceryTableBody");
      const msg = document.getElementById("noGroceriesMsg");
      const tableWrapper = document.getElementById("groceryTableWrapper");
      if (!tbody) return;

      tbody.innerHTML = "";
      const groceries = monthData.groceries || [];

      if (groceries.length === 0) {
        if (tableWrapper) tableWrapper.classList.add("hidden");
        if (msg) msg.classList.remove("hidden");
        return;
      }
      if (tableWrapper) tableWrapper.classList.remove("hidden");
      if (msg) msg.classList.add("hidden");

      // Sort groceries: unchecked first, checked last
      const sortedGroceries = [...groceries].sort((a, b) => {
        const aChecked = !!a.is_checked;
        const bChecked = !!b.is_checked;
        if (aChecked === bChecked) return 0;
        return aChecked ? 1 : -1;
      });

      let grandTotal = 0;

      for (const item of sortedGroceries) {
        const tr = document.createElement("tr");
        const isChecked = !!item.is_checked;
        const itemTotal = (item.estimated_cost || 0) * (item.quantity || 1);
        grandTotal += itemTotal;

        tr.className = `hover:bg-gray-50 group ${isChecked ? 'opacity-60' : ''}`;

        tr.innerHTML = `
          <td class="px-4 py-3 text-center">
            <input type="checkbox" ${isChecked ? 'checked' : ''} 
              class="accent-[#0e4f23] w-4 h-4 cursor-pointer grocery-checkbox" 
              data-id="${item.id}">
          </td>
          <td class="px-4 py-3 ${isChecked ? 'line-through text-gray-400' : ''}">${escapeHtml(item.item_name)}</td>
          <td class="px-4 py-3 text-right ${isChecked ? 'text-gray-400' : ''}">${formatCurrency(item.estimated_cost)}</td>
          <td class="px-4 py-3 text-center ${isChecked ? 'text-gray-400' : ''}">${item.quantity}</td>
          <td class="px-4 py-3 text-right ${isChecked ? 'text-gray-400' : ''} font-medium">${formatCurrency(itemTotal)}</td>
          <td class="px-4 py-3 text-center">
            <div class="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="btn-edit-grocery text-blue-600 hover:text-blue-800" data-id="${item.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-del-grocery text-red-500 hover:text-red-700" data-id="${item.id}">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </td>
      `;

        tbody.appendChild(tr);

        // Attach checkbox event listener
        const checkbox = tr.querySelector('.grocery-checkbox');
        if (checkbox) {
          checkbox.addEventListener('change', (e) => toggleGroceryCheck(item.id, e.target.checked));
        }

        // Attach edit/delete listeners
        const btnEdit = tr.querySelector('.btn-edit-grocery');
        const btnDel = tr.querySelector('.btn-del-grocery');
        if (btnEdit) btnEdit.addEventListener('click', () => editGroceryItem(item));
        if (btnDel) btnDel.addEventListener('click', () => deleteGroceryItem(item.id));
      }

      // Update grand total display
      const grandTotalEl = document.getElementById('groceryGrandTotal');
      if (grandTotalEl) {
        grandTotalEl.textContent = formatCurrency(grandTotal);
      }
    }

    function toggleGroceryCheck(id, checked) {
      // Optimistic update locally
      const store = loadStore();
      const mData = ensureMonth(store, ACTIVE_MONTH);
      const item = (mData.groceries || []).find(g => g.id == id);
      if (item) {
        item.is_checked = checked ? 1 : 0;
        saveStore(store);
      }
      loadMonthToUI(ACTIVE_MONTH);

      fetch(`/api/groceries/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_checked: checked })
      })
        .then(res => res.json())
        .catch(err => console.error('Error toggling grocery sync:', err));
    }

    function editGroceryItem(item) {
      // Find the row
      const rows = document.querySelectorAll('#groceryTableBody tr');
      let targetRow = null;

      for (const row of rows) {
        const editBtn = row.querySelector('.btn-edit-grocery');
        if (editBtn && editBtn.dataset.id == item.id) {
          targetRow = row;
          break;
        }
      }

      if (!targetRow) return;

      const isChecked = !!item.is_checked;

      // Replace row with editable version
      targetRow.innerHTML = `
        <td class="px-4 py-3 text-center">
          <input type="checkbox" ${isChecked ? 'checked' : ''} disabled
            class="accent-[#0e4f23] w-4 h-4 cursor-not-allowed opacity-50">
        </td>
        <td class="px-4 py-3">
          <input type="text" value="${escapeHtml(item.item_name)}" 
            class="edit-item-name w-full min-w-[120px] border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-[#f9a825]">
        </td>
        <td class="px-4 py-3">
          <input type="number" value="${item.estimated_cost}" step="0.01" min="0"
            class="edit-item-cost w-20 border border-gray-300 rounded px-2 py-1 text-sm text-right focus:outline-none focus:border-[#f9a825]">
        </td>
        <td class="px-4 py-3">
          <input type="number" value="${item.quantity}" min="1"
            class="edit-item-qty w-16 border border-gray-300 rounded px-2 py-1 text-sm text-center focus:outline-none focus:border-[#f9a825]">
        </td>
        <td class="px-4 py-3 text-right text-gray-500 font-medium text-sm">
          (calculating...)
        </td>
        <td class="px-4 py-3 text-center">
          <div class="flex items-center justify-center gap-2">
            <button class="btn-save-grocery text-green-600 hover:text-green-800 font-medium text-sm" data-id="${item.id}">
              <i class="fas fa-check"></i> Save
            </button>
            <button class="btn-cancel-grocery text-gray-600 hover:text-gray-800 text-sm" data-id="${item.id}">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </td>
      `;

      // Attach save handler
      const saveBtn = targetRow.querySelector('.btn-save-grocery');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          const newName = targetRow.querySelector('.edit-item-name').value.trim();
          const newCost = parseFloat(targetRow.querySelector('.edit-item-cost').value) || 0;
          const newQty = parseInt(targetRow.querySelector('.edit-item-qty').value) || 1;

          if (!newName) {
            alert('Item name is required');
            return;
          }

          saveGroceryEdit(item.id, newName, newCost, newQty);
        });
      }

      // Attach cancel handler
      const cancelBtn = targetRow.querySelector('.btn-cancel-grocery');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          loadMonthToUI(ACTIVE_MONTH); // Re-render to cancel edit
        });
      }

      // Focus on item name input
      const nameInput = targetRow.querySelector('.edit-item-name');
      if (nameInput) nameInput.focus();
    }

    function saveGroceryEdit(id, itemName, cost, quantity) {
      // Optimistic update locally
      const store = loadStore();
      const mData = ensureMonth(store, ACTIVE_MONTH);
      const item = (mData.groceries || []).find(g => g.id == id);
      if (item) {
        item.item_name = itemName;
        item.estimated_cost = cost;
        item.quantity = quantity;
        saveStore(store);
      }
      loadMonthToUI(ACTIVE_MONTH);

      fetch(`/api/groceries/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          item_name: itemName,
          quantity,
          estimated_cost: cost
        })
      })
        .then(res => res.json())
        .catch(err => console.error('Error saving grocery sync:', err));
    }


    let pendingDeleteGroceryId = null;

    function deleteGroceryItem(id) {
      pendingDeleteGroceryId = id;
      const modal = document.getElementById('deleteGroceryModal');
      if (modal) modal.classList.remove('hidden');
    }

    function executeDeleteGrocery() {
      if (!pendingDeleteGroceryId) return;

      // Optimistic delete locally
      const store = loadStore();
      const mData = ensureMonth(store, ACTIVE_MONTH);
      mData.groceries = (mData.groceries || []).filter(g => g.id !== pendingDeleteGroceryId);
      saveStore(store);

      const idToDelete = pendingDeleteGroceryId;
      closeDeleteGroceryModal();
      loadMonthToUI(ACTIVE_MONTH);

      fetch(`/api/groceries/${idToDelete}`, { method: 'DELETE' })
        .then(res => res.json())
        .catch(err => console.error('Error deleting grocery sync:', err));
    }

    function closeDeleteGroceryModal() {
      const modal = document.getElementById('deleteGroceryModal');
      if (modal) modal.classList.add('hidden');
      pendingDeleteGroceryId = null;
    }

    function clearGroceryForm() {
      document.getElementById('groceryItemName').value = '';
      document.getElementById('groceryQuantity').value = '1';
      document.getElementById('groceryCost').value = '';
    }


    // Global state for sorting/filtering
    let expenseSortOrder = 'desc'; // 'asc' or 'desc'
    let expenseFilterCategory = ''; // empty = all
    let editingExpenseId = null; // ID of the expense currently being edited inline

    function renderExpensesTable(monthData) {
      const tbody = document.getElementById("expenseTableBody");
      const msg = document.getElementById("noExpensesMsg");
      if (!tbody) return;

      tbody.innerHTML = "";
      let exps = monthData.expenses || [];

      // Apply category filter
      if (expenseFilterCategory) {
        exps = exps.filter(exp => exp.category === expenseFilterCategory);
      }

      // Apply sorting: Default to entry order (ID) for DESC to show most recent at top
      exps = [...exps].sort((a, b) => {
        if (expenseSortOrder === 'desc') {
          return b.id - a.id;
        } else {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateA - dateB;
        }
      });

      // Update sort icon
      const sortIcon = document.getElementById("expenseSortIcon");
      if (sortIcon) {
        sortIcon.className = expenseSortOrder === 'desc'
          ? 'fas fa-sort-down text-[#f9a825]'
          : 'fas fa-sort-up text-[#f9a825]';
      }

      if (exps.length === 0) {
        if (msg) msg.classList.remove("hidden");
        return;
      }
      if (msg) msg.classList.add("hidden");

      for (const exp of exps) {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 group";

        if (editingExpenseId && (editingExpenseId == exp.id)) {
          // Render Inline Edit Row
          tr.className = "bg-amber-50";
          tr.innerHTML = `
            <td class="px-6 py-3">
              <input type="date" id="inlineEditDate" value="${exp.date}" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:border-[#f9a825]">
            </td>
            <td class="px-6 py-3">
              <select id="inlineEditCategory" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:border-[#f9a825]">
                ${categories.map(c => `<option value="${c}" ${c === exp.category ? 'selected' : ''}>${c}</option>`).join('')}
              </select>
            </td>
            <td class="px-6 py-3">
              <textarea id="inlineEditNotes" rows="2" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:border-[#f9a825] resize-y">${escapeHtml(exp.notes)}</textarea>
            </td>
            <td class="px-6 py-3 text-right">
              <input type="number" id="inlineEditAmount" value="${exp.amount}" step="0.01" class="w-full border border-gray-300 rounded px-2 py-1 text-xs text-right focus:border-[#f9a825]">
            </td>
            <td class="px-6 py-3 text-center">
              <div class="flex items-center justify-center gap-2">
                <button class="btn-save-inline text-green-600 hover:text-green-800" title="Save">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-cancel-inline text-gray-500 hover:text-gray-700" title="Cancel">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </td>
          `;

          const btnSave = tr.querySelector(".btn-save-inline");
          const btnCancel = tr.querySelector(".btn-cancel-inline");

          btnSave.addEventListener("click", () => saveInlineEdit(exp.id));
          btnCancel.addEventListener("click", cancelInlineEdit);

        } else {
          // Render Normal Row
          tr.innerHTML = `
            <td class="px-6 py-3 text-gray-600">${exp.date}</td>
            <td class="px-6 py-3 font-medium text-gray-800 break-words">
              <span class="inline-block w-2.5 h-2.5 rounded-full mr-1.5" style="background-color: ${categoryColors[exp.category] || '#ccc'}"></span>
              ${escapeHtml(exp.category)}
              ${exp.isEco ? '<span class="ml-1 text-[#4caf50]" title="Eco-Spending">üçÉ</span>' : ''}
            </td>
            <td class="px-6 py-3 text-gray-500 break-words" title="${escapeHtml(exp.notes)}">${escapeHtml(exp.notes)}</td>
            <td class="px-6 py-3 text-right font-medium text-[#0e4f23]">${formatCurrency(exp.amount)}</td>
            <td class="px-6 py-3 text-center">
               <div class="flex items-center justify-center gap-2 ${editingExpenseId ? 'opacity-0' : 'opacity-0 group-hover:opacity-100'} transition-opacity">
                  <button class="btn-edit-inline text-blue-600 hover:text-blue-800" data-id="${exp.id}" ${editingExpenseId ? 'disabled' : ''}>
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-del-exp text-red-500 hover:text-red-700" data-id="${exp.id}" ${editingExpenseId ? 'disabled' : ''}>
                    <i class="fas fa-trash-alt"></i>
                  </button>
               </div>
            </td>
          `;

          const btnEdit = tr.querySelector(".btn-edit-inline");
          const btnDel = tr.querySelector(".btn-del-exp");

          if (btnEdit) btnEdit.addEventListener("click", () => startInlineEdit(exp.id));
          if (btnDel) btnDel.addEventListener("click", () => deleteExpenseRequest(exp.id));
        }

        tbody.appendChild(tr);
      }
    }

    function startInlineEdit(id) {
      editingExpenseId = id;
      loadMonthToUI(ACTIVE_MONTH);
    }

    function cancelInlineEdit() {
      editingExpenseId = null;
      loadMonthToUI(ACTIVE_MONTH);
    }

    function saveInlineEdit(id) {
      const amount = Number(document.getElementById("inlineEditAmount").value);
      const category = document.getElementById("inlineEditCategory").value;
      const date = document.getElementById("inlineEditDate").value;
      const notes = document.getElementById("inlineEditNotes").value;

      if (!amount || amount <= 0 || !category || !date) {
        alert("Please fill in Amount, Category, and Date.");
        return;
      }

      const updatedExp = {
        id,
        amount,
        category,
        date,
        notes
      };

      editingExpenseId = null;
      saveExpenseForMonth(updatedExp, true);
    }

    function editExpenseRequest(exp) {
      // Legacy edit functionality bypassed in favor of inline edit
      startInlineEdit(exp.id);
    }

    function deleteExpenseRequest(id) {
      // Open modal
      const modal = document.getElementById("deleteExpenseModal");
      if (modal) {
        modal.dataset.expenseId = id;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
    }

    function closeDeleteExpenseModal() {
      const modal = document.getElementById("deleteExpenseModal");
      if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    }

    function executeDeleteExpense() {
      const modal = document.getElementById("deleteExpenseModal");
      const id = modal.dataset.expenseId;
      if (!id) return;

      // Optimistic delete locally
      const store = loadStore();
      const mData = ensureMonth(store, ACTIVE_MONTH);
      mData.expenses = mData.expenses.filter(e => e.id != id);
      saveStore(store);

      // Update UI instantly
      loadMonthToUI(ACTIVE_MONTH);
      closeDeleteExpenseModal();

      // If it's a temporary ID, it's not in the DB, so we're done.
      if (String(id).startsWith("id-")) return;

      // Sync to backend in background
      fetch(`/api/expenses/${id}`, {
        method: 'DELETE'
      })
        .then(r => r.json())
        .catch(e => {
          console.error("Delete sync error:", e);
        });
    }

    // ---- Persistence actions ----
    function saveSettingsForMonth() {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);

      const income = Number(document.getElementById("incomeInput").value) || 0;
      const limit = Number(document.getElementById("budgetInput").value) || 0;

      monthData.settings.income = income;
      monthData.settings.budget_limit = limit;

      saveStore(store);

      // Sync to backend
      fetch('/api/budget-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          month_iso: ACTIVE_MONTH,
          income: income,
          budget_limit: limit
        })
      }).then(r => r.json()).then(d => {
        if (d.error) console.error("Failed to save budget:", d.error);
      }).catch(e => console.error("Sync error:", e));
    }

    function saveExpenseForMonth(exp, isEditMode = false) {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);

      if (isEditMode) {
        // Update local array
        const idx = monthData.expenses.findIndex(e => e.id == exp.id);
        if (idx !== -1) {
          monthData.expenses[idx] = { ...monthData.expenses[idx], ...exp };
        }
      } else {
        // New item
        monthData.expenses.push(exp);
      }

      saveStore(store);
      // Optimistic UI Update: refresh everything instantly from local store
      loadMonthToUI(ACTIVE_MONTH);

      // Sync to backend (Create or Update) in background
      const method = exp.id && isEditMode ? 'PUT' : 'POST';
      const url = exp.id && isEditMode ? `/api/expenses/${exp.id}` : '/api/expenses';

      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          category: exp.category,
          amount: exp.amount,
          expense_date: exp.date,
          description: exp.notes,
          is_eco: exp.isEco ?? false,
          month_iso: ACTIVE_MONTH
        })
      }).then(r => r.json()).then(d => {
        if (d.id || d.updated) {
          // If we created a new expense, update temp ID to database ID
          if (typeof exp.id === 'string' && exp.id.startsWith('id-')) {
            const freshStore = loadStore();
            const freshMonth = ensureMonth(freshStore, ACTIVE_MONTH);
            const itemIdx = freshMonth.expenses.findIndex(e => e.id == exp.id);
            if (itemIdx !== -1) {
              freshMonth.expenses[itemIdx].id = d.id;
              saveStore(freshStore);
              loadMonthToUI(ACTIVE_MONTH); // Silent refresh to update internal IDs
            }
          }
        }
      }).catch(e => console.error("Expense sync error:", e));
    }

    function saveGroceryForMonth(g) {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);
      monthData.groceries.push(g);
      saveStore(store);

      // Sync to backend
      fetch('/api/groceries', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          item_name: g.item,
          quantity: g.qty,
          estimated_cost: g.cost,
          category: g.category,
          month_iso: ACTIVE_MONTH
        })
      }).then(r => r.json()).catch(e => console.error("Grocery sync error:", e));
    }

    function hardDeleteGroceryById(groceryId) {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);
      monthData.groceries = (monthData.groceries || []).filter(x => x.id !== groceryId);
      saveStore(store);
    }

    function setGroceryChecked(groceryId, checked) {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);
      const target = (monthData.groceries || []).find(x => x.id === groceryId);
      if (target) target.checked = !!checked;
      saveStore(store);
    }

    function hardDeleteCategory(cat) {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);

      monthData.expenses = (monthData.expenses || []).filter(e => e.category !== cat);
      monthData.groceries = (monthData.groceries || []).filter(g => (g.category || "Groceries") !== cat);

      saveStore(store);
    }

    // ---- Draft persistence ----
    function saveDraftExpense() {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);

      monthData.drafts.expense = {
        amount: document.getElementById("expenseAmount").value,
        category: document.getElementById("expenseCategory").value,
        date: document.getElementById("expenseDate").value,
        notes: document.getElementById("expenseNotes").value
      };

      saveStore(store);
    }

    function saveDraftGrocery() {
      const store = loadStore();
      const monthData = ensureMonth(store, ACTIVE_MONTH);

      monthData.drafts.grocery = {
        item: document.getElementById("groceryItem").value,
        qty: document.getElementById("groceryQty").value,
        cost: document.getElementById("groceryCost").value,
        category: document.getElementById("groceryBudgetCat").value
      };

      saveStore(store);
    }

    function applyDrafts(monthData) {
      const dExp = monthData.drafts?.expense || {};
      const amt = document.getElementById("expenseAmount");
      const cat = document.getElementById("expenseCategory");
      const dat = document.getElementById("expenseDate");
      const not = document.getElementById("expenseNotes");

      if (amt && dExp.amount !== undefined) amt.value = dExp.amount;
      if (cat && dExp.category !== undefined) cat.value = dExp.category;
      if (dat && dExp.date !== undefined) dat.value = dExp.date;
      if (not && dExp.notes !== undefined) not.value = dExp.notes;

      const dGro = monthData.drafts?.grocery || {};
      const gi = document.getElementById("groceryItem");
      const gq = document.getElementById("groceryQty");
      const gc = document.getElementById("groceryCost");
      const gb = document.getElementById("groceryBudgetCat");

      if (gi && dGro.item !== undefined) gi.value = dGro.item;
      if (gq && dGro.qty !== undefined) gq.value = dGro.qty;
      if (gc && dGro.cost !== undefined) gc.value = dGro.cost;
      if (gb && dGro.category !== undefined) gb.value = dGro.category;

      updateEcoCheckbox();
    }



    function clearExpenseForm(hardClearDraft = true) {
      document.getElementById("expenseId").value = "";
      document.getElementById("expenseAmount").value = "";
      document.getElementById("expenseCategory").value = "";
      document.getElementById("expenseDate").value = "";
      document.getElementById("expenseNotes").value = "";
      document.getElementById("ecoCheckbox").checked = false;
      document.getElementById("expenseSubmitLabel").textContent = "Add Expense";

      if (hardClearDraft) {
        const store = loadStore();
        const monthData = ensureMonth(store, ACTIVE_MONTH);
        monthData.drafts.expense = { amount: "", category: "", date: "", notes: "" };
        saveStore(store);
      }

      updateEcoCheckbox();
    }



    // ---- Month load to UI ----
    function loadMonthToUI(monthIso) {
      const store = loadStore();
      const monthData = ensureMonth(store, monthIso);

      // Settings -> inputs
      const incomeInput = document.getElementById("incomeInput");
      const budgetInput = document.getElementById("budgetInput");
      if (incomeInput) incomeInput.value = monthData.settings.income ?? 0;
      if (budgetInput) budgetInput.value = monthData.settings.budget_limit ?? 0;

      // Groceries table
      renderGroceryList(monthData);

      // Expense table
      renderExpensesTable(monthData);

      // Totals
      const { totalSpent, categoryTotals } = computeTotals(monthData);
      TOTAL_SPENT = totalSpent;
      CATEGORY_TOTALS = categoryTotals;

      // Drafts (retain input values when coming back)
      applyDrafts(monthData);

      saveStore(store);
      updateSummaryUI();
    }

    // ---- DOM Ready ----
    document.addEventListener("DOMContentLoaded", () => {
      // Prioritize server-selected month
      const serverIso = "{{ selected_month_iso }}";
      if (serverIso && /^\d{4}-\d{2}$/.test(serverIso)) {
        ACTIVE_MONTH = serverIso;
        // Sync local selection
        const s = loadStore();
        s.ui.selectedMonth = ACTIVE_MONTH;
        saveStore(s);
      } else {
        ACTIVE_MONTH = getActiveMonthIso();
      }

      // Hydrate from server data
      const sIncome = Number("{{ budget_data.income }}");
      const sLimit = Number("{{ budget_data.budget_limit }}");

      const st = loadStore();
      const mData = ensureMonth(st, ACTIVE_MONTH);

      // Update settings
      mData.settings.income = sIncome;
      mData.settings.budget_limit = sLimit;

      // Hydrate expenses from server
      const sExpenses = {{ expenses | tojson | safe
    }};
    if (sExpenses && sExpenses.length > 0) {
      // Map server fields to local fields if necessary
      mData.expenses = sExpenses.map(e => ({
        id: e.id,
        category: e.category,
        amount: e.amount,
        date: e.expense_date,
        notes: e.description,
        isEco: !!e.is_eco
      }));
    }

    // Scan for custom categories
    syncCategoriesWithData(mData.expenses || []);

    // Populate category filter dropdown
    function populateExpenseCategoryFilter() {
      const filterSelect = document.getElementById("expenseCategoryFilter");
      if (!filterSelect) return;

      const currentVal = filterSelect.value;
      filterSelect.innerHTML = '<option value="">Categories</option>';

      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        filterSelect.appendChild(opt);
      });

      filterSelect.value = currentVal;
    }

    function populateGroceryCategorySelect() {
      const select = document.getElementById("groceryCategorySelect");
      if (!select) return;

      const currentVal = select.value;
      select.innerHTML = '';

      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });

      select.value = currentVal || 'Groceries';
    }

    populateExpenseCategoryFilter();
    populateGroceryCategorySelect();

    const btnAddCat = document.getElementById("btnAddCategory");
    const btnDelCat = document.getElementById("btnDelCategory");
    if (btnAddCat) {
      btnAddCat.addEventListener("click", addNewCategory);
    }
    if (btnDelCat) {
      btnDelCat.addEventListener("click", deleteCurrentCategory);
    }

    // Modal listeners
    const btnCancelCat = document.getElementById("cancelCategoryBtn");
    const btnConfirmCat = document.getElementById("confirmCategoryBtn");
    const catInput = document.getElementById("newCategoryInput");

    if (btnCancelCat) btnCancelCat.addEventListener("click", closeCategoryModal);
    if (btnConfirmCat) btnConfirmCat.addEventListener("click", confirmAddCategory);
    if (catInput) {
      catInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") confirmAddCategory();
        if (e.key === "Escape") closeCategoryModal();
      });
    }

    // Delete Modal listeners
    const btnCancelDel = document.getElementById("cancelDelCatBtn");
    const btnConfirmDel = document.getElementById("confirmDelCatBtn");
    const btnCloseDel = document.getElementById("closeDelCatBtn");

    if (btnCancelDel) btnCancelDel.addEventListener("click", closeDeleteModal);
    if (btnConfirmDel) btnConfirmDel.addEventListener("click", executeDeleteCategory);
    if (btnCloseDel) btnCloseDel.addEventListener("click", closeDeleteModal);

    // Expense sort/filter event listeners
    const expenseCategoryFilterEl = document.getElementById("expenseCategoryFilter");
    if (expenseCategoryFilterEl) {
      expenseCategoryFilterEl.addEventListener("change", (e) => {
        expenseFilterCategory = e.target.value;
        loadMonthToUI(ACTIVE_MONTH);
      });
    }

    const expenseDateSortBtn = document.getElementById("expenseDateSort");
    if (expenseDateSortBtn) {
      expenseDateSortBtn.addEventListener("click", () => {
        expenseSortOrder = expenseSortOrder === 'desc' ? 'asc' : 'desc';
        loadMonthToUI(ACTIVE_MONTH);
      });
    }

    // Grocery List Modal event listeners
    const openGroceryListBtn = document.getElementById("openGroceryListBtn");
    const closeGroceryListBtn = document.getElementById("closeGroceryListBtn");
    const groceryListModal = document.getElementById("groceryListModal");

    if (openGroceryListBtn && groceryListModal) {
      openGroceryListBtn.addEventListener("click", () => {
        groceryListModal.classList.remove("hidden");
      });
    }

    if (closeGroceryListBtn && groceryListModal) {
      closeGroceryListBtn.addEventListener("click", () => {
        groceryListModal.classList.add("hidden");
      });
    }

    // Close modal when clicking outside
    if (groceryListModal) {
      groceryListModal.addEventListener("click", (e) => {
        if (e.target === groceryListModal) {
          groceryListModal.classList.add("hidden");
        }
      });
    }

    // Delete Grocery Modal listeners
    const cancelDeleteGroceryBtn = document.getElementById("cancelDeleteGrocery");
    const confirmDeleteGroceryBtn = document.getElementById("confirmDeleteGrocery");

    if (cancelDeleteGroceryBtn) {
      cancelDeleteGroceryBtn.addEventListener("click", closeDeleteGroceryModal);
    }

    if (confirmDeleteGroceryBtn) {
      confirmDeleteGroceryBtn.addEventListener("click", executeDeleteGrocery);
    }


    // Delete Expense Modal listeners
    const btnCancelExp = document.getElementById("cancelDelExpBtn");
    const btnConfirmExp = document.getElementById("confirmDelExpBtn");

    if (btnCancelExp) btnCancelExp.addEventListener("click", closeDeleteExpenseModal);
    if (btnConfirmExp) btnConfirmExp.addEventListener("click", executeDeleteExpense);

    // Initial render of options (since we cleared the hardcoded ones in HTML mostly)
    updateCategorySelect();

    // Hydrate groceries from server
    const sGroceries = {{ groceries | tojson | safe }};
    if (sGroceries && sGroceries.length > 0) {
      mData.groceries = sGroceries.map(g => ({
        id: g.id,
        item_name: g.item_name,
        quantity: g.quantity,
        estimated_cost: g.estimated_cost,
        category: g.category,
        is_checked: !!g.is_checked
      }));
    }

    saveStore(st);



    loadMonthToUI(ACTIVE_MONTH);

    // Save settings
    const budgetInput = document.getElementById("budgetInput");
    const incomeInput = document.getElementById("incomeInput");

    if (budgetInput) {
      budgetInput.addEventListener("change", () => {
        saveSettingsForMonth();
        loadMonthToUI(ACTIVE_MONTH);
      });
    }

    function handleBudgetEnter(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        saveSettingsForMonth();
        updateSummaryUI();
        e.target.blur();
      }
    }

    if (incomeInput) {
      incomeInput.addEventListener("change", () => {
        saveSettingsForMonth();
        updateSummaryUI();
      });
      incomeInput.addEventListener("keydown", handleBudgetEnter);
    }

    if (budgetInput) {
      budgetInput.addEventListener("change", () => {
        saveSettingsForMonth();
        updateSummaryUI();
      });
      budgetInput.addEventListener("keydown", handleBudgetEnter);
    }

    // Draft listeners
    ["expenseAmount", "expenseCategory", "expenseDate", "expenseNotes"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", saveDraftExpense);
      if (el && id !== "expenseNotes") el.addEventListener("change", saveDraftExpense);
    });

    ["groceryItem", "groceryQty", "groceryCost", "groceryBudgetCat"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", saveDraftGrocery);
      if (el) el.addEventListener("change", saveDraftGrocery);
    });

    // Eco checkbox updates
    const expenseAmount = document.getElementById("expenseAmount");
    if (expenseAmount) expenseAmount.addEventListener("input", updateEcoCheckbox);

    // Add expense
    const expenseForm = document.getElementById("expenseForm");
    if (expenseForm) {
      expenseForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const amount = Number(document.getElementById("expenseAmount").value);
        const category = document.getElementById("expenseCategory").value;
        const date = document.getElementById("expenseDate").value;
        const notes = document.getElementById("expenseNotes").value;
        const isEco = document.getElementById("ecoCheckbox").checked;

        if (!amount || amount <= 0 || !category || !date) {
          alert("Please fill in Amount, Category, and Date.");
          return;
        }

        const expenseId = document.getElementById("expenseId").value;
        const isEdit = !!expenseId;


        const exp = {
          id: expenseId || uuid(), // Use existing ID if edit, else new
          amount,
          category,
          date,
          notes,
          isEco,
          createdAt: nowIso() // Note: In real app, preserve original createdAt if edit
        };

        // Clear form immediately
        clearExpenseForm(true);

        // Sync (Local + Remote)
        saveExpenseForMonth(exp, isEdit);
      });
    }

    // Cancel expense (clears draft too)
    const clearExpenseBtn = document.getElementById("clearExpenseBtn");
    if (clearExpenseBtn) {
      clearExpenseBtn.addEventListener("click", () => clearExpenseForm(true));
    }

    // Add grocery
    const groceryForm = document.getElementById("groceryForm");
    if (groceryForm) {
      groceryForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const itemName = document.getElementById("groceryItemName").value.trim();
        const quantity = Number(document.getElementById("groceryQuantity").value) || 1;
        const cost = Number(document.getElementById("groceryCost").value);

        if (!itemName || !cost) {
          alert("Please provide an item name and estimated cost.");
          return;
        }

        // Add new item
        fetch('/api/groceries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item_name: itemName,
            quantity,
            estimated_cost: cost,
            month_iso: ACTIVE_MONTH
          })
        })
          .then(res => res.json())
          .then(data => {
            // Add to local storage
            const store = loadStore();
            const mData = ensureMonth(store, ACTIVE_MONTH);
            mData.groceries = mData.groceries || [];
            mData.groceries.push({
              id: data.id,
              item_name: itemName,
              quantity,
              estimated_cost: cost,
              is_checked: 0
            });
            saveStore(store);
            groceryForm.reset();
            loadMonthToUI(ACTIVE_MONTH);
          })
          .catch(err => {
            console.error('Error adding grocery:', err);
            alert('Failed to add item');
          });
      });
    }

    // Grocery table actions
    const groceryTableBody = document.getElementById("groceryTableBody");
    if (groceryTableBody) {
      groceryTableBody.addEventListener("click", (e) => {
        const row = e.target.closest("tr");
        if (!row || !row.dataset.id) return;

        const groceryId = row.dataset.id;

        if (e.target.classList.contains("btn-remove")) {
          if (confirm("Delete this item?")) {
            hardDeleteGroceryById(groceryId);
            loadMonthToUI(ACTIVE_MONTH);
          }
        }
      });

      groceryTableBody.addEventListener("change", (e) => {
        const row = e.target.closest("tr");
        if (!row || !row.dataset.id) return;

        if (e.target.classList.contains("grocery-check")) {
          setGroceryChecked(row.dataset.id, e.target.checked);
        }
      });
    }


    });
  </script>

</body>

</html>